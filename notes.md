```bash
leppikallio @ tuonela /opt/Code/aws-codepipeline-docker-vulnerability-scan [eu-localization L|✚ 1…7]
└─ 13:32 ▶ aws --region eu-central-1 cloudformation create-stack --stack-name coreos-clair-vpc-stack --template-body file://networking-template.yaml
{
    "StackId": "arn:aws:cloudformation:eu-central-1:xxxxxxxxxxxx:stack/coreos-clair-vpc-stack/3aaae6d0-e8ee-11e9-aecb-02625fbcaeee"
}
```

```
leppikallio @ tuonela /opt/Code/aws-codepipeline-docker-vulnerability-scan [eu-localization L|✚ 1…7]
└─ 13:36 ▶ aws --region eu-central-1 cloudformation wait stack-create-complete --stack-name coreos-clair-vpc-stack
```

```bash
leppikallio @ tuonela /opt/Code/aws-codepipeline-docker-vulnerability-scan [eu-localization L|✚ 1…7]
└─ 13:38 ▶ aws cloudformation describe-stacks --stack-name coreos-clair-vpc-stack --query 'Stacks[].Outputs[]'
[
    {
        "OutputKey": "PrivateSubnets",
        "OutputValue": "subnet-01dbb35980ece23d5,subnet-0ac52344ae2449eb6",
        "ExportName": "coreos-clair-vpc-stack-PrivateSubnets"
    },
    {
        "OutputKey": "VpcId",
        "OutputValue": "vpc-0168393e4531e9906",
        "ExportName": "coreos-clair-vpc-stack-VpcId"
    },
    {
        "OutputKey": "Cloud9EnvironmentName",
        "OutputValue": "Codepipeline-Docker-Vulnerability-Scan",
        "Description": "AWS Cloud9 Environment Name"
    },
    {
        "OutputKey": "PublicSubnets",
        "OutputValue": "subnet-0c3a9ce9ad34747ab,subnet-0fce3b1036404912d",
        "ExportName": "coreos-clair-vpc-stack-PublicSubnets"
    }
]
```

*Continuing locally for now, not using the Cloud9 like in the original sample.*

```bash
leppikallio @ tuonela /opt/Code/aws-codepipeline-docker-vulnerability-scan [eu-localization L|●1✚ 3…7]
└─ 13:45 ▶ aws --region eu-central-1 ecr create-repository --repository-name coreos-clair
{
    "repository": {
        "repositoryArn": "arn:aws:ecr:eu-central-1:xxxxxxxxxxxx:repository/coreos-clair",
        "registryId": "xxxxxxxxxxxx",
        "repositoryName": "coreos-clair",
        "repositoryUri": "xxxxxxxxxxxx.dkr.ecr.eu-central-1.amazonaws.com/coreos-clair",
        "createdAt": 1570446230.0
    }
}
```

```bash
leppikallio @ tuonela /opt/Code/aws-codepipeline-docker-vulnerability-scan [eu-localization L|●2✚ 3…7]
└─ 14:03 ▶ docker build -t xxxxxxxxxxxx.dkr.ecr.eu-central-1.amazonaws.com/coreos-clair:latest ./coreos-clair
Sending build context to Docker daemon  13.82kB
Step 1/4 : FROM quay.io/coreos/clair:v2.0.3
v2.0.3: Pulling from coreos/clair
[DEPRECATION NOTICE] registry v2 schema1 support will be removed in an upcoming release. Please contact admins of the quay.io registry NOW to avoid future disruption.
ff3a5c916c92: Pull complete
1a649ea86bca: Pull complete
ce35f4d5f86a: Pull complete
7db6b75ae47d: Pull complete
fc46bec5ec29: Pull complete
09df88ac2d3b: Pull complete
5da1d8fd3332: Pull complete
deed625e1171: Pull complete
Digest: sha256:b7818bff204d7c9ddb205671964fa3fd5827cb435ee89831c260a4a67e5a335a
Status: Downloaded newer image for quay.io/coreos/clair:v2.0.3
 ---> 4a156c74cb38
Step 2/4 : COPY config.yaml /config/config.yaml
 ---> 952b7e5615ee
Step 3/4 : ENTRYPOINT []
 ---> Running in 8cae5000cd21
Removing intermediate container 8cae5000cd21
 ---> e3f239f687ea
Step 4/4 : CMD sed -i "s/localhost/$DB_HOST/" /config/config.yaml && exec /clair -config=/config/config.yaml
 ---> Running in 09c8726a001a
Removing intermediate container 09c8726a001a
 ---> 0394cb96cca3
Successfully built 0394cb96cca3
Successfully tagged xxxxxxxxxxxx.dkr.ecr.eu-central-1.amazonaws.com/coreos-clair:latest
```

```bash
leppikallio @ tuonela /opt/Code/aws-codepipeline-docker-vulnerability-scan [eu-localization L|●2✚ 3…7]
└─ 14:08 ▶ aws --region eu-central-1 ecr get-login --no-include-email | bash
WARNING! Using --password via the CLI is insecure. Use --password-stdin.
Login Succeeded
```

![Note regarding the get-login](images/get-login-note.png)

```bash
leppikallio @ tuonela /opt/Code/aws-codepipeline-docker-vulnerability-scan [eu-localization L|●2✚ 3…8]
└─ 14:26 ▶ docker push xxxxxxxxxxxx.dkr.ecr.eu-central-1.amazonaws.com/coreos-clair:latest
The push refers to repository [xxxxxxxxxxxx.dkr.ecr.eu-central-1.amazonaws.com/coreos-clair]
392ea7eaa0b9: Pushed
8b0a689d9afa: Pushed
339a51b31027: Pushed
78471c4fb600: Pushed
77513e782a67: Pushed
bf84a5ea12db: Pushed
b09386d6aa0f: Pushed
1ed7a5e2d1b3: Pushed
cd7100a72410: Pushed
latest: digest: sha256:4d10c5234b639029b0b53061304490af778990086171a45e6ba26b192c4c97bf size: 2203
```

```bash
leppikallio @ tuonela /opt/Code/aws-codepipeline-docker-vulnerability-scan [eu-localization L|●2✚ 3…8]
└─ 14:39 ▶ aws --region eu-central-1 cloudformation create-stack \
--stack-name coreos-clair-stack \
--template-body file://coreos-clair/clair-template.yaml \
--capabilities CAPABILITY_IAM \
--parameters \
ParameterKey="VpcId",ParameterValue="vpc-0168393e4531e9906" \
ParameterKey="PublicSubnets",ParameterValue=\"subnet-0c3a9ce9ad34747ab,subnet-0fce3b1036404912d\" \
ParameterKey="PrivateSubnets",ParameterValue=\"subnet-01dbb35980ece23d5,subnet-0ac52344ae2449eb6\" \
ParameterKey="ECRRepositoryUri",ParameterValue="xxxxxxxxxxxx.dkr.ecr.eu-central-1.amazonaws.com/coreos-clair"
{
    "StackId": "arn:aws:cloudformation:eu-central-1:xxxxxxxxxxxx:stack/coreos-clair-stack/3018f960-e8f7-11e9-b302-02722d612c06"
}
```

```bash
leppikallio @ tuonela /opt/Code/aws-codepipeline-docker-vulnerability-scan [eu-localization L|●2✚ 3…8]
└─ 14:41 ▶ aws cloudformation wait stack-create-complete --stack-name coreos-clair-stack
```

```bash
leppikallio @ tuonela /opt/Code/aws-codepipeline-docker-vulnerability-scan [eu-localization L|●2✚ 3…8]
└─ 14:48 ▶ aws cloudformation describe-stacks \
--stack-name coreos-clair-stack \
--query 'Stacks[].Outputs[]'
[
    {
        "OutputKey": "ECSClusterArn",
        "OutputValue": "arn:aws:ecs:eu-central-1:xxxxxxxxxxxx:cluster/clair-demo-cluster",
        "Description": "ECS Cluster ARN"
    },
    {
        "OutputKey": "ECSClusterName",
        "OutputValue": "clair-demo-cluster",
        "Description": "ECS Cluster Name"
    },
    {
        "OutputKey": "ClairECSServiceName",
        "OutputValue": "arn:aws:ecs:eu-central-1:xxxxxxxxxxxx:service/coreos-clair-stack-ClairECSService-19EO30X54V2K0",
        "Description": "ECS Service Name"
    },
    {
        "OutputKey": "ClairAlbUrl",
        "OutputValue": "http://coreo-Clair-HGMUR2F9CR2A-694635190.eu-central-1.elb.amazonaws.com:6060",
        "Description": "URL of the Clair ALB"
    },
    {
        "OutputKey": "ClairAlbDnsName",
        "OutputValue": "coreo-Clair-HGMUR2F9CR2A-694635190.eu-central-1.elb.amazonaws.com",
        "Description": "Clair ALB DNS Name"
    }
]
```
