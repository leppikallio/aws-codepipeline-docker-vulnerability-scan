```bash
leppikallio @ tuonela /opt/Code
└─ 14:55 ▶ aws codecommit create-repository --repository-name my-nginx-website
{
    "repositoryMetadata": {
        "accountId": "xxxxxxxxxxxx",
        "repositoryId": "153198a7-5e0b-4b02-8576-0286ffe0b7e0",
        "repositoryName": "my-nginx-website",
        "lastModifiedDate": 1570449334.731,
        "creationDate": 1570449334.731,
        "cloneUrlHttp": "https://git-codecommit.eu-central-1.amazonaws.com/v1/repos/my-nginx-website",
        "cloneUrlSsh": "ssh://git-codecommit.eu-central-1.amazonaws.com/v1/repos/my-nginx-website",
        "Arn": "arn:aws:codecommit:eu-central-1:xxxxxxxxxxxx:my-nginx-website"
    }
}
```

```bash
leppikallio @ tuonela /opt/Code
└─ 15:00 ▶ git config --global credential.helper '!aws codecommit credential-helper $@'
```
```bash
leppikallio @ tuonela /opt/Code
└─ 15:00 ▶ git config --global credential.UseHttpPath true
```
```bash
leppikallio @ tuonela /opt/Code
└─ 15:00 ▶ git config --global user.email "petteri.leppikallio@nordcloud.com"
```
```bash
leppikallio @ tuonela /opt/Code
└─ 15:01 ▶ git config --global user.name "leppikallio"
```
```bash
leppikallio @ tuonela /opt/Code
└─ 15:01 ▶ git clone https://git-codecommit.eu-central-1.amazonaws.com/v1/repos/my-nginx-website
Cloning into 'my-nginx-website'...
warning: You appear to have cloned an empty repository.
```
```bash
leppikallio @ tuonela /opt/Code
└─ 15:01 ▶ cp -R aws-codepipeline-docker-vulnerability-scan/nginx-website/. my-nginx-website/
```
```bash
└─ 15:02 ▶ cd my-nginx-website/
leppikallio @ tuonela /opt/Code/my-nginx-website [master L|…6]
└─ 15:02 ▶ git add *
```
```bash
leppikallio @ tuonela /opt/Code/my-nginx-website [master L|●6]
└─ 15:03 ▶ git commit -am "Initial commit"
`.pre-commit-config.yaml` config file not found. Skipping `pre-commit`.
[master (root-commit) af7d89a] Initial commit
 6 files changed, 251 insertions(+)
 create mode 100644 Dockerfile
 create mode 100644 Dockerfile-amznlinux
 create mode 100644 buildspec.yml
 create mode 100644 default.conf
 create mode 100644 index.html
 create mode 100644 nginx-website-template.yaml
```
```bash
leppikallio @ tuonela /opt/Code/my-nginx-website [master|✔]
└─ 15:03 ▶ git push
Enumerating objects: 8, done.
Counting objects: 100% (8/8), done.
Delta compression using up to 4 threads
Compressing objects: 100% (8/8), done.
Writing objects: 100% (8/8), 3.23 KiB | 662.00 KiB/s, done.
Total 8 (delta 0), reused 0 (delta 0)
To https://git-codecommit.eu-central-1.amazonaws.com/v1/repos/my-nginx-website
 * [new branch]      master -> master
```

```bash
leppikallio @ tuonela /opt/Code/my-nginx-website [master|✔]
└─ 15:09 ▶ aws ecr create-repository --repository-name nginx-website
{
    "repository": {
        "repositoryArn": "arn:aws:ecr:eu-central-1:xxxxxxxxxxxx:repository/nginx-website",
        "registryId": "xxxxxxxxxxxx",
        "repositoryName": "nginx-website",
        "repositoryUri": "xxxxxxxxxxxx.dkr.ecr.eu-central-1.amazonaws.com/nginx-website",
        "createdAt": 1570450299.0
    }
}
```

```bash
leppikallio @ tuonela /opt/Code/my-nginx-website [master|✔]
└─ 15:11 ▶ docker build -f Dockerfile-amznlinux -t xxxxxxxxxxxx.dkr.ecr.eu-central-1.amazonaws.com/nginx-website:latest .
Sending build context to Docker daemon  67.58kB
Step 1/7 : FROM amazonlinux:2
 ---> b94321659aca
Step 2/7 : RUN amazon-linux-extras install -y nginx1.12
 ---> Running in d466838bd673
Topic nginx1.12 has end-of-support date of 2019-09-20
Loaded plugins: ovl, priorities
Cleaning repos: amzn2-core amzn2extra-nginx1.12
0 metadata files removed
0 sqlite files removed
0 metadata files removed
Loaded plugins: ovl, priorities
Resolving Dependencies
--> Running transaction check
.
.
.
* Extra topic has reached end of support.
Removing intermediate container d466838bd673
 ---> f048c25b1308
Step 3/7 : CMD ["nginx", "-g", "daemon off;"]
 ---> Running in 0c8d5585f354
Removing intermediate container 0c8d5585f354
 ---> 57d5c4bc8d12
Step 4/7 : COPY default.conf /etc/nginx/conf.d/
 ---> d63134b1564a
Step 5/7 : COPY index.html /usr/share/nginx/html/
 ---> d4392abeb5ce
Step 6/7 : EXPOSE 80
 ---> Running in 0bbf9f49914f
Removing intermediate container 0bbf9f49914f
 ---> 9cd4068da2d0
Step 7/7 : EXPOSE 443
 ---> Running in 5efa97df28b2
Removing intermediate container 5efa97df28b2
 ---> d7eb523bee8d
Successfully built d7eb523bee8d
Successfully tagged xxxxxxxxxxxx.dkr.ecr.eu-central-1.amazonaws.com/nginx-website:latest
```

```bash
leppikallio @ tuonela /opt/Code/my-nginx-website [master|✔]
└─ 15:14 ▶ docker push xxxxxxxxxxxx.dkr.ecr.eu-central-1.amazonaws.com/nginx-website:latest
The push refers to repository [xxxxxxxxxxxx.dkr.ecr.eu-central-1.amazonaws.com/nginx-website]
58ae5a84d211: Pushed
b6d1379cceb4: Pushed
1ca6e1402670: Pushed
f387c8b346c8: Pushed
latest: digest: sha256:1eaaa98ddaa8d24bd21102407e9675807b93aa37feb951dda9dbe50783df166b size: 1156
```

```bash
aws --region eu-central-1 cloudformation create-stack \
--stack-name nginx-website-stack \
--template-body file://nginx-website/nginx-website-template.yaml \
--capabilities CAPABILITY_IAM \
--parameters \
ParameterKey="VpcId",ParameterValue="vpc-0168393e4531e9906" \
ParameterKey="PublicSubnets",ParameterValue=\"subnet-0c3a9ce9ad34747ab,subnet-0fce3b1036404912d\" \
ParameterKey="PrivateSubnets",ParameterValue=\"subnet-01dbb35980ece23d5,subnet-0ac52344ae2449eb6\" \
ParameterKey="ECRRepositoryUri",ParameterValue="xxxxxxxxxxxx.dkr.ecr.eu-central-1.amazonaws.com/nginx-website"
{
    "StackId": "arn:aws:cloudformation:eu-central-1:xxxxxxxxxxxx:stack/nginx-website-stack/3ca13ac0-e8fd-11e9-b67d-0ac5bdeb388c"
}
```

```bash
leppikallio @ tuonela /opt/Code/aws-codepipeline-docker-vulnerability-scan [eu-localization L|●3✚ 4…8]
└─ 15:23 ▶ aws cloudformation wait stack-create-complete --stack-name nginx-website-stack
```

```bash
leppikallio @ tuonela /opt/Code/aws-codepipeline-docker-vulnerability-scan [eu-localization L|●3✚ 4…8]
└─ 15:26 ▶ aws cloudformation describe-stacks --stack-name nginx-website-stack --query 'Stacks[].Outputs[]'
[
    {
        "OutputKey": "WebsiteAlbUrl",
        "OutputValue": "http://nginx-Websi-M66O33AYV63T-601301073.eu-central-1.elb.amazonaws.com",
        "Description": "URL of the Website ALB"
    },
    {
        "OutputKey": "WebsiteECSServiceName",
        "OutputValue": "nginx-website-stack-WebsiteService-6AVKJZU23TIT",
        "Description": "Website ECS Service Name"
    }
]
```

```bash
aws cloudformation create-stack \
--stack-name nginx-website-codepipeline-stack \
--template-body file://clair-codepipeline-template.yaml \
--capabilities CAPABILITY_IAM \
--disable-rollback \
--parameters \
ParameterKey="EcrRepositoryArn",ParameterValue="arn:aws:ecr:eu-central-1:xxxxxxxxxxxx:repository/nginx-website" \
ParameterKey="EcrRepositoryUri",ParameterValue="xxxxxxxxxxxx.dkr.ecr.eu-central-1.amazonaws.com/nginx-website" \
ParameterKey="ClairAlbDnsName",ParameterValue="coreo-Clair-HGMUR2F9CR2A-694635190.eu-central-1.elb.amazonaws.com" \
ParameterKey="EcsServiceName",ParameterValue="nginx-website-stack-WebsiteService-6AVKJZU23TIT" \
ParameterKey="NginxWebsiteCodeCommitRepoArn",ParameterValue="arn:aws:codecommit:eu-central-1:xxxxxxxxxxxx:my-nginx-website"
{
    "StackId": "arn:aws:cloudformation:eu-central-1:xxxxxxxxxxxx:stack/nginx-website-codepipeline-stack/d0f11af0-e8fe-11e9-b424-0248cb00433a"
}
```
